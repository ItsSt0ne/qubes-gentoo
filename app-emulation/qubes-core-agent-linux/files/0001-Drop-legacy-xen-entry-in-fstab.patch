From d3c14629a7145b617f2afc11e1897cc5e3339853 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fr=C3=A9d=C3=A9ric=20Pierret=20=28fepitre=29?=
 <frederic.pierret@qubes-os.org>
Date: Fri, 24 Jul 2020 16:07:39 +0200
Subject: [PATCH] Drop legacy xen entry in fstab

---
 filesystem/fstab                 |  1 -
 vm-systemd/75-qubes-vm.preset    |  3 ++-
 vm-systemd/qubes-sysinit.service |  2 +-
 vm-systemd/qubes-sysinit.sh      | 11 +----------
 4 files changed, 4 insertions(+), 13 deletions(-)

diff --git a/filesystem/fstab b/filesystem/fstab
index 4673ee7..df2b112 100644
--- a/filesystem/fstab
+++ b/filesystem/fstab
@@ -10,5 +10,4 @@ tmpfs                   /dev/shm                tmpfs   defaults,size=1G
 devpts                  /dev/pts                devpts  gid=5,mode=620  0 0
 sysfs                   /sys                    sysfs   defaults        0 0
 proc                    /proc                   proc    defaults        0 0
-xen                     /proc/xen               xenfs   defaults        0 0
 /dev/xvdi	/mnt/removable	auto noauto,user,rw 0 0
diff --git a/vm-systemd/75-qubes-vm.preset b/vm-systemd/75-qubes-vm.preset
index 9933fe9..6bdcfb1 100644
--- a/vm-systemd/75-qubes-vm.preset
+++ b/vm-systemd/75-qubes-vm.preset
@@ -100,7 +100,6 @@ enable qubes-iptables.service
 enable qubes-updates-proxy-forwarder.socket
 enable haveged.service
 enable chronyd.service
-enable xendriverdomain.service
 enable systemd-timesyncd.service
 enable qubes-sync-time.service
 enable qubes-sync-time.timer
@@ -108,3 +107,5 @@ enable qubes-sync-time.timer
 # Disable useless Xen services in Qubes VM
 disable xenstored.service
 disable xenconsoled.service
+disable proc-xen.mount
+disable xendriverdomain.service
\ No newline at end of file
diff --git a/vm-systemd/qubes-sysinit.service b/vm-systemd/qubes-sysinit.service
index 815e56d..bc4a678 100644
--- a/vm-systemd/qubes-sysinit.service
+++ b/vm-systemd/qubes-sysinit.service
@@ -2,7 +2,7 @@
 Description=Init Qubes Services settings
 DefaultDependencies=no
 Before=sysinit.target
-After=proc-xen.mount systemd-modules-load.service qubes-db.service
+After=systemd-modules-load.service qubes-db.service
 
 [Service]
 Type=oneshot
diff --git a/vm-systemd/qubes-sysinit.sh b/vm-systemd/qubes-sysinit.sh
index b86fb14..e48f281 100755
--- a/vm-systemd/qubes-sysinit.sh
+++ b/vm-systemd/qubes-sysinit.sh
@@ -17,7 +17,7 @@ if systemd_version_changed ; then
 fi
 
 # Wait for xenbus initialization
-while [ ! -e /dev/xen/xenbus ] && [ -e /proc/xen/xenbus ]; do
+while [ ! -e /dev/xen/xenbus ]; do
   sleep 0.1
 done
 
@@ -27,15 +27,6 @@ chmod 0775 /var/run/qubes
 mkdir -p /var/run/qubes-service
 mkdir -p /var/run/xen-hotplug
 
-# Set permissions to /proc/xen/xenbus, so normal user can talk to xenstore, to
-# open vchan connection. Note that new code uses /dev/xen/xenbus (which have
-# permissions set by udev), so this probably can go away soon
-chmod 666 /proc/xen/xenbus
-
-# Set permissions to /proc/xen/privcmd, so a user in qubes group can access
-chmod 660 /proc/xen/privcmd
-chgrp qubes /proc/xen/privcmd
-
 # Set default services depending on VM type
 is_appvm && DEFAULT_ENABLED=$DEFAULT_ENABLED_APPVM && touch /var/run/qubes/this-is-appvm
 is_netvm && DEFAULT_ENABLED=$DEFAULT_ENABLED_NETVM && touch /var/run/qubes/this-is-netvm
-- 
2.25.4

